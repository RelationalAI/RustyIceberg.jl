networks:
  iceberg_net:

services:
  minio:
    container_name: minio
    image: quay.io/minio/minio:latest
    ports:
      - "9000:9000" # MinIO API port
      - "9001:9001" # MinIO Console port
    environment:
      MINIO_ROOT_USER: root
      MINIO_ROOT_PASSWORD: password
      MINIO_DOMAIN: minio
    networks:
      iceberg_net:
        aliases:
          - warehouse.minio
    command: server --console-address ":9001" /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  setup_bucket:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    networks:
      iceberg_net:
    entrypoint: >
      /bin/sh -c "
      echo 'Setting up MinIO bucket...';
      mc alias set minio http://minio:9000 root password;
      mc mb minio/warehouse --ignore-existing;
      echo 'MinIO bucket setup complete';
      "

  polaris:
    container_name: polaris
    image: apache/polaris:latest
    ports:
      - "8181:8181"  # Polaris REST API
      - "8182:8182"  # Polaris healthcheck
    environment:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: root
      AWS_SECRET_ACCESS_KEY: password
      POLARIS_BOOTSTRAP_CREDENTIALS: POLARIS,root,s3cr3t
      polaris.realm-context.realms: POLARIS
      quarkus.otel.sdk.disabled: "true"
      polaris.features.ALLOW_INSECURE_STORAGE_TYPES: "true"
      polaris.readiness.ignore-severe-issues: "true"
    networks:
      iceberg_net:
    depends_on:
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8182/healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 5

  spark-init:
    build:
      context: .
      dockerfile: spark/Dockerfile
    container_name: spark-init
    networks:
      iceberg_net:
    depends_on:
      setup_bucket:
        condition: service_completed_successfully
      polaris:
        condition: service_healthy
    volumes:
      - ../assets/tpch:/input
      - ../assets/incremental:/input_incremental
      - ./scripts/init-datasets.py:/app/init-datasets.py
    environment:
      - AWS_ACCESS_KEY_ID=root
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://minio:9000
    working_dir: /app
    command: python3 init-datasets.py

  polaris-setup:
    image: alpine/curl:latest
    container_name: polaris-setup
    depends_on:
      polaris:
        condition: service_healthy
      spark-init:
        condition: service_completed_successfully
    networks:
      iceberg_net:
    environment:
      - CLIENT_ID=root
      - CLIENT_SECRET=s3cr3t
    volumes:
      - ./assets/polaris:/polaris
    entrypoint: /bin/sh
    command:
      - -c
      - >-
        echo 'Setting up Polaris catalog...' &&
        chmod +x /polaris/setup-all.sh &&
        /polaris/setup-all.sh POLARIS &&
        echo 'Polaris setup complete!'

  table-creation:
    build:
      context: .
      dockerfile: spark/Dockerfile
    container_name: table-creation
    networks:
      iceberg_net:
    depends_on:
      polaris-setup:
        condition: service_completed_successfully
    volumes:
      - ./scripts/create-tables.py:/app/create-tables.py
    environment:
      - CLIENT_ID=root
      - CLIENT_SECRET=s3cr3t
      - POLARIS_API=http://polaris:8181/api/management/v1
      - POLARIS_CATALOG_API=http://polaris:8181/api/catalog/v1
    working_dir: /app
    command: python3 /app/create-tables.py

  spark-iceberg:
    build:
      context: .
      dockerfile: spark/Dockerfile
    container_name: spark-iceberg
    networks:
      iceberg_net:
    depends_on:
      table-creation:
        condition: service_completed_successfully
    volumes:
      - ./warehouse:/home/iceberg/warehouse
    environment:
      - AWS_ACCESS_KEY_ID=root
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://minio:9000
      - ICEBERG_CATALOG__WAREHOUSE=s3://warehouse
      - ICEBERG_CATALOG__URI=http://polaris:8181
      - ICEBERG_CATALOG__CREDENTIAL=root:s3cr3t
    ports:
      - 8080:8080  # Spark Web UI
      - 10000:10000  # Spark Driver
      - 10001:10001  # Spark Executor
    command: tail -f /dev/null  # Keep container running for interactive use
