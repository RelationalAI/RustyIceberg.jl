networks:
  iceberg_net:

services:
  minio:
    container_name: minio
    image: minio/minio:latest
    ports:
      - "9000:9000" # MinIO API port
      - "9001:9001" # MinIO Console port
    environment:
      MINIO_ROOT_USER: root
      MINIO_ROOT_PASSWORD: password
      MINIO_DOMAIN: minio
    networks:
      iceberg_net:
        aliases:
          - warehouse.minio
    command: server --console-address ":9001" /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  setup_bucket:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    networks:
      iceberg_net:
    entrypoint: >
      /bin/sh -c "
      echo 'Setting up MinIO bucket...';
      mc alias set minio http://minio:9000 root password;
      mc mb minio/warehouse --ignore-existing;
      echo 'MinIO bucket setup complete';
      "

  polaris:
    container_name: polaris
    image: apache/polaris:latest
    ports:
      - "8181:8181"  # Polaris REST API
      - "8182:8182"  # Polaris healthcheck
    environment:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: root
      AWS_SECRET_ACCESS_KEY: password
      POLARIS_BOOTSTRAP_CREDENTIALS: POLARIS,root,s3cr3t
      polaris.realm-context.realms: POLARIS
      quarkus.otel.sdk.disabled: "true"
      polaris.features.ALLOW_INSECURE_STORAGE_TYPES: "true"
      polaris.readiness.ignore-severe-issues: "true"
    networks:
      iceberg_net:
    depends_on:
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "http://localhost:8182/healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 5

  init:
    image: python:3.11-slim
    container_name: init
    networks:
      iceberg_net:
    depends_on:
      setup_bucket:
        condition: service_completed_successfully
      polaris:
        condition: service_healthy
    volumes:
      - ../assets/tpch:/input
      - ../assets/incremental:/input_incremental
      - ./scripts/init-datasets.py:/app/init-datasets.py
    environment:
      - AWS_ACCESS_KEY_ID=root
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://minio:9000
    working_dir: /app
    command: sh -c "pip install --no-cache-dir boto3 requests && python3 init-datasets.py"

  table-creation:
    image: python:3.11-slim
    container_name: table-creation
    networks:
      iceberg_net:
    depends_on:
      polaris:
        condition: service_healthy
      init:
        condition: service_completed_successfully
    volumes:
      - ./scripts/create-tables.py:/app/create-tables.py
    environment:
      - CLIENT_ID=root
      - CLIENT_SECRET=s3cr3t
      - POLARIS_API=http://polaris:8181/api/management/v1
      - POLARIS_CATALOG_API=http://polaris:8181/api/catalog/v1
    working_dir: /app
    command: sh -c "pip install --no-cache-dir boto3 requests && python3 /app/create-tables.py"

  spark-iceberg:
    image: tabulario/spark-iceberg
    container_name: spark-iceberg
    build: spark/
    networks:
      iceberg_net:
    depends_on:
      table-creation:
        condition: service_completed_successfully
    volumes:
      - ./warehouse:/home/iceberg/warehouse
      - ./notebooks:/home/iceberg/notebooks/notebooks
    environment:
      - AWS_ACCESS_KEY_ID=root
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://minio:9000
    ports:
      - 8888:8888
      - 8080:8080
      - 10000:10000
      - 10001:10001
